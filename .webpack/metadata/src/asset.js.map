{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/asset.js","webpack:///external \"aws-sdk\"","webpack:///external \"babel-runtime/core-js/json/stringify\"","webpack:///external \"babel-runtime/helpers/asyncToGenerator\"","webpack:///external \"babel-runtime/regenerator\"","webpack:///external \"sharp\"","webpack:///external \"source-map-support/register\"","webpack:///external \"uuid\""],"names":["Sharp","require","AWS","uuid","config","update","region","s3","S3","dynamodb","DynamoDB","client","DocumentClient","service","done","err","res","callback","result","statusCode","body","message","headers","uploadHandler","event","context","JSON","parse","params","Bucket","process","env","S3_BUCKET","Key","filename","Body","Buffer","from","ContentType","upload","promise","s3Response","metadataHandler","console","log","Item","v4","put","DYNAMODB_TABLE","resizeHandler","originalKey","Records","object","key","includes","getObject","originalPhoto","resize","toBuffer","buffer","putObject"],"mappings":"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","file":"src/asset.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./src/asset.js\");\n","const Sharp = require('sharp');\nconst AWS = require('aws-sdk');\nconst uuid = require('uuid');\n\nAWS.config.update({ region: 'eu-west-1' });\nconst s3 = new AWS.S3();\n\nconst dynamodb = new AWS.DynamoDB();\nconst client = new AWS.DynamoDB.DocumentClient({ service: dynamodb });\n\nconst done = (err, res, callback) => {\n  const result = {\n    statusCode: err ? '400' : '200',\n    body: err ? err.message : JSON.stringify(res),\n    headers: {\n      'Content-Type': 'application/json',\n    }\n  };\n\n  callback(null, result);\n};\n\nexport const uploadHandler = async (event, context, callback) => {\n  const body = JSON.parse(event.body);\n  const params = {\n    Bucket: process.env.S3_BUCKET,\n    Key: `key/${body.filename}`,\n    Body: Buffer.from(body.body, 'base64'),\n    ContentType: 'image/png'\n  };\n\n  const s3Response = await s3.upload(params).promise();\n\n  return done(null, s3Response, callback);\n}\n\n\nexport const metadataHandler = async (event, context, callback) => {\n  console.log(event);\n  const body = JSON.parse(event.body);\n  const Item = {\n    filename: body.filename,\n    uuid: uuid.v4()\n  }\n\n  await client.put({ \"TableName\": process.env.DYNAMODB_TABLE, Item }).promise();\n\n  done(null, {}, callback);\n}\n\nexport const resizeHandler = async (event, context, callback) => {\n  const originalKey = event.Records[0].s3.object.key;\n  const key = `resize/iii-resized.png`;\n\n  if (originalKey.includes('resized')) {\n    done(null, {}, callback);\n  }\n\n  const originalPhoto = await s3.getObject({ Bucket: process.env.S3_BUCKET, Key: originalKey }).promise();\n  const buffer = await Sharp(originalPhoto.Body)\n    .resize(100, 100)\n    .toBuffer();\n\n  await s3.putObject({\n    Body: buffer,\n    Bucket: process.env.S3_BUCKET,\n    ContentType: 'image/png',\n    Key: key,\n  }).promise();\n\n  done(null, {}, callback);\n}\n\n// const key = event.queryStringParameters.key;\n// const match = key.match(/((\\d+)x(\\d+))\\/(.*)/);\n// const dimensions = match[1];\n// const width = parseInt(match[2], 10);\n// const height = parseInt(match[3], 10);\n// const originalKey = match[4];\n\n// if(ALLOWED_DIMENSIONS.size > 0 && !ALLOWED_DIMENSIONS.has(dimensions)) {\n//    callback(null, {\n//     statusCode: '403',\n//     headers: {},\n//     body: '',\n//   });\n//   return;\n// }\n\n// S3.getObject({Bucket: BUCKET, Key: originalKey}).promise()\n//   .then(data => Sharp(data.Body)\n//     .resize(width, height)\n//     .toFormat('png')\n//     .toBuffer()\n//   )\n//   .then(buffer => S3.putObject({\n//       Body: buffer,\n//       Bucket: BUCKET,\n//       ContentType: 'image/png',\n//       Key: key,\n//     }).promise()\n//   )\n//   .then(() => callback(null, {\n//       statusCode: '301',\n//       headers: {'location': `${URL}/${key}`},\n//       body: '',\n//     })\n//   )\n//   .catch(err => callback(err))","module.exports = require(\"aws-sdk\");","module.exports = require(\"babel-runtime/core-js/json/stringify\");","module.exports = require(\"babel-runtime/helpers/asyncToGenerator\");","module.exports = require(\"babel-runtime/regenerator\");","module.exports = require(\"sharp\");","module.exports = require(\"source-map-support/register\");","module.exports = require(\"uuid\");"],"sourceRoot":""}